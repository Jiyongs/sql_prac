## 튜닝 해보기
### 첫 번째, 쿼리 디자인을 잘 하자
#### 규칙1. select는 필요한 결과값만을 요구하기
```sql
select name, price
from stuff
where id = 'bu1032' -- 필요한 행만 고른다
```

#### 규칙2. where절에서 인덱스를 타게 하기
- where절에서 컬럼이 변형되면 안 됨
  ```sql
  select *
  from stuff
  where id+'' = 'bu1032' -- 인덱스가 걸린 id를 변형하여, 인덱스가 사용되지 않음 (clustered index scan)
  -- 해결법 : where id = 'bu1032' + '' -- id가 아닌 결과값을 변형하여, 인덱스가 사용 됨 (clustered index seek)
  ```

#### 규칙3. count(컬럼명) 대신 count(*)을 사용하기
- count(컬럼명) : null을 제외한 행 개수 반환
- count(*) : null과 중복을 포함한 행 개수 반환

#### 규칙4. 커서 또는 임시테이블을 최대한 줄이기
- 성능에 좋은 순서 : 테이블변수 > 임시테이블 > 커서
- 커서는 내부적으로 임시테이블을 사용하면서도 부가적 기능때문에 서버 자원을 더 낭비함
- 커서는 프로시저가 끝날 때까지 실제 테이블에 잠금을 걸기 때문에, 다른 작업들이 대기하는 문제 발생 -> 테이블변수는 실제 테이블에 잠금을 걸지 않음
- 테이블변수 만들기
  ```sql
  declare @tmptbl table(
    col1 int not null,
    col2 varchar(10) null
  )
  ```

#### 규칙5. view 줄이기
- view는 보안상 이슈를 제외하면, 불필요한 부하가 발생

#### 규칙6. 저장 프로시저 사용하기
- 저장 프로시저는 복잡한 sql을 단순화하고, 보안문제를 해결하며, 빠른 성능과 매개변수 및 리턴 값 사용이 가능
- 저장 프로시저를 생성하고, 반복했을 때 발생하는 일
  - 생성 : 구문 분석 + 표준화 + 보안점검 + 저장
  - 1번째 실행 : 보안점검 + 최적화 + 컴파일 및 실행계획 캐시 저장 + 실행
  - 2번째 실행 이상 : 캐시된 실행계획 실행
- 결론적으로, 반복적으로 실행되어야 하는 sql은 저장 프로시저가 월등히 빠르고 편리!

#### 규칙7. 저장 프로시저를 적절히 리컴파일하며 사용하기
- 인덱스 추가나 열을 바꾸는 등 데이터가 변화하면, 실행계획도 바뀌어야 함 -> 리컴파일 필요
- 저장 프로시저의 리컴파일 모드 3가지
  1. CREATE PROCEDURE [WITH RECOMPILE] : 실행계획 캐시 안 하고, 실행 시마다 컴파일 됨 (속도 느림)
  2. EXECUTE [WITH RECOMPILE] : 지금 이 순간만 리컴파일
  3. SP_RECOMPILE : 다음 실행 시에 1번째 실행처럼 컴파일되게 함

#### 규칙8. 저장 프로시저 작명 시 'sp_' 접두어는 쓰지 않기
- 시스템 저장 프로시저의 이름이 'sp_'로 시작하기 때문에 헷갈리니 주의!

#### 규칙9. 모든 개체의 소유자는 dbo로 지정하는 것을 권장
- 소유자가 다르면 소유권 체인 문제가 발생하기 때문. 이건 그냥 권장사항
- 소유자를 dbo로 바꾸기
  ```sql
  sp_changeobjectowner [abc.tbl], dbo -- 소유자를 'abc'에서 'dbo'로 변경
  ```

#### 규칙10. 데드락이 발생하는 부분을 라이브락으로 변경하기
- Dead Lock : 2개 이상의 트랜잭션이 서로가 실행해야 할 내용을 잠그고 있어, 교착상태에 이른 상황
- 데드락 상태에서 한 쪽을 취소하면 시스템 성능저하를 부름
- 그래서, 데드락을 방지하기 위해 순차적으로 실행되도록 변경하여 해결함 (= Live Lock)

#### set nocount on 사용하기
- 불필요한 메세지가 네트워크 트래픽을 낭비하지 않도록 set nocount on 을 사용
- 'n개 행이 적용되었습니다.' 와 같은 메세지가 출력되지 않음
  ```sql
  set nocount on
  select * from titles
  ```
  
## reference
- 'SQL Server 성능 향상을 위한 튜닝 가이드', 차주언
